<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Empowerment Library</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        .container { display: flex; min-height: 100vh; margin-top: 150px; }

        .sidebar {
            width: 250px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            padding: 25px; height: calc(100vh - 80px); position: fixed; left: 0; top: 140px;
            box-shadow: 2px 0 20px rgba(0,0,0,0.1); z-index: 1000; overflow-y: auto;
        }

        .sidebar ul { list-style: none; padding: 5px; }
        .sidebar ul li a {
            display: flex; margin: 1.5rem 0 1rem 0; color: #2c3e50; font-weight: 600;
            text-decoration: none; padding: 15px 20px; border-radius: 12px;
            transition: all 0.3s ease; align-items: center; border: 2px solid transparent;
        }
        .sidebar ul li a i { margin-right: 15px; font-size: 1.2rem; width: 25px; text-align: center; }
        .sidebar ul li a:hover { background: linear-gradient(135deg, #3498db, #2c3e50); color: white; transform: translateX(10px); border-color: #3498db; }
        .sidebar ul li a.active { background: linear-gradient(135deg, #2c3e50, #3498db); color: white; box-shadow: 0 5px 15px rgba(52,152,219,0.3); }

        .main-content { flex: 1; padding: 30px; margin-left: 250px; }

        .dashboard-header { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 25px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.2); }
        .dashboard-title { font-size: 2.5rem; color: #2c3e50; margin-bottom: 10px; font-weight: 700; }
        .dashboard-subtitle { color: #7f8c8d; font-size: 1.1rem; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-bottom: 30px; }

        .stat-card { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 25px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.2); transition: transform .3s, box-shadow .3s; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.15); }

        .stat-icon { width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-bottom: 15px; color: white; }
        .stat-card.clubs .stat-icon { background: linear-gradient(135deg, #3498db, #2980b9); }
        .stat-card.events .stat-icon { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .stat-card.members .stat-icon { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .stat-card.contacts .stat-icon { background: linear-gradient(135deg, #f39c12, #e67e22); }

        .stat-value { font-size: 2.5rem; font-weight: 700; color: #2c3e50; margin-bottom: 5px; }
        .stat-label { color: #7f8c8d; font-size: 1rem; font-weight: 600; }
        .stat-change { display: flex; align-items: center; margin-top: 10px; font-size: .9rem; font-weight: 600; }
        .stat-change.positive { color: #27ae60; } .stat-change.negative { color: #e74c3c; }

        .charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 30px; }
        .chart-card { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 25px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.2); }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .chart-title { font-size: 1.3rem; font-weight: 700; color: #2c3e50; }

        .recent-activity { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 25px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.2); margin-bottom: 30px; }
        .activity-list { list-style: none; }
        .activity-item { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid #ecf0f1; }
        .activity-item:last-child { border-bottom: none; }
        .activity-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 15px; color: white; }
        .activity-icon.club { background: #3498db; } .activity-icon.event { background: #e74c3c; } .activity-icon.member { background: #2ecc71; }

        .quick-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 30px; }
        .action-btn { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 20px; border-radius: 12px; text-decoration: none; color: #2c3e50; text-align: center; transition: all .3s; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 2px solid transparent; }
        .action-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); border-color: #3498db; color: #3498db; }
        .action-icon { font-size: 2rem; margin-bottom: 10px; color: #3498db; }

        /* ===== MEMBERS LIST ===== */
        .members-card { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 25px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.2); margin-bottom: 30px; }
        .members-table { width: 100%; border-collapse: collapse; font-size: .95rem; }
        .members-table th, .members-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ecf0f1; }
        .members-table th { background: #f8f9fa; color: #2c3e50; font-weight: 600; }
        .members-table tr:hover { background-color: #f1f5f9; }
        .members-table-container { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; }

        .status-badge { padding: 4px 10px; border-radius: 12px; font-size: .8rem; font-weight: 600; }
        .status-active { background: #d4edda; color: #155724; }
        .status-suspended { background: #f8d7da; color: #721c24; }

        .action-btn-small { padding: 5px 10px; font-size: .8rem; margin-right: 5px; border: none; border-radius: 6px; cursor: pointer; }
        .btn-suspend { background: #ffc107; color: #212529; }
        .btn-unsuspend { background: #28a745; color: white; }
        .btn-delete { background: #dc3545; color: white; }

        .no-data { text-align: center; color: #7f8c8d; font-style: italic; padding: 20px; }

        /* Toast */
        #toast { position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; color: white; font-weight: 600; z-index: 2000; transform: translateX(120%); transition: transform .4s ease; }
        #toast.show { transform: translateX(0); }
        .toast-success { background: #28a745; }
        .toast-error { background: #dc3545; }

        .loading { display: inline-block; width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 6px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 1024px) { .charts-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) {
            .container { margin-top: 70px; }
            .sidebar { width: 200px; transform: translateX(-100%); transition: transform .3s; top: 70px; height: calc(100vh - 70px); }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; padding: 20px; }
            .stats-grid { grid-template-columns: 1fr; }
            .hamburger { display: flex; }
            .nav-menu { display: none; flex-direction: column; position: absolute; top: 70px; right: 0; background: #2c3e50; width: 200px; border-radius: 0 0 0 10px; z-index: 100; }
            .nav-menu.active { display: flex; }
        }
    </style>
</head>
<body>
    <!-- CLEAN HEADER: Only Logo + Logout -->
    <header>
        <div class="hero">
            <div class="logo">
                <a href="index.html"><img src="Images/EMP.png" alt="Empowerment Library Logo"></a>
            </div>
            <nav>
                <div class="navlinks">
                    <ul class="nav-menu">
                        <li style="padding: 15px;">
                            <a class="nav-item" href="admin-login.html">
                                Logout <i class="fa fa-sign-in" aria-hidden="true"></i>
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="hamburger">
                    <span class="bar"></span>
                    <span class="bar"></span>
                    <span class="bar"></span>
                </div>
            </nav>
        </div>
    </header>

    <div class="container">
        <aside class="sidebar">
            <ul>
                <li><a href="createEvent.html" id="manageEvents"><i class="fa fa-calendar"></i> Events</a></li>
                <li><a href="manageContact.html" id="manageContact"><i class="fas fa-address-book"></i> Contact</a></li>
                <li><a href="createBookClub.html" id="manageBookClub"><i class="fa fa-book"></i> Book Club</a></li>
                <li><a href="manageBooks.html" id="manageBooks"><i class="fas fa-book-medical"></i> Manage Books</a></li>
                <li><a href="#" class="active" id="analyticsLink"><i class="fas fa-chart-line"></i> Analytics</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <div class="dashboard-header">
                <h1 class="dashboard-title">Admin Dashboard</h1>
                <p class="dashboard-subtitle">Empowerment Library</p>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card clubs"><div class="stat-icon"><i class="fas fa-book"></i></div><div class="stat-value" id="totalClubs">0</div><div class="stat-label">Active Book Clubs</div><div class="stat-change positive"><i class="fas fa-arrow-up"></i><span>+3 this month</span></div></div>
                <div class="stat-card events"><div class="stat-icon"><i class="fas fa-calendar"></i></div><div class="stat-value" id="totalEvents">0</div><div class="stat-label">Upcoming Events</div><div class="stat-change positive"><i class="fas fa-arrow-up"></i><span>+2 this week</span></div></div>
                <div class="stat-card members"><div class="stat-icon"><i class="fas fa-users"></i></div><div class="stat-value" id="totalMembers">0</div><div class="stat-label">Total Members</div><div class="stat-change positive"><i class="fas fa-arrow-up"></i><span>+24 this month</span></div></div>
                <div class="stat-card contacts"><div class="stat-icon"><i class="fas fa-envelope"></i></div><div class="stat-value" id="totalContacts">0</div><div class="stat-label">New Contacts</div><div class="stat-change negative"><i class="fas fa-arrow-down"></i><span>-5 from last week</span></div></div>
            </div>

            <!-- Members List with Suspend/Delete -->
            <div class="members-card">
                <h3 class="chart-title">Members List</h3>
                <div class="members-table-container">
                    <table class="members-table" id="membersTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="membersTableBody"></tbody>
                    </table>
                </div>
                <div id="membersLoading" style="display:none; text-align:center; padding:15px;">
                    <span class="loading"></span>Loading members...
                </div>
                <div id="membersEmpty" class="no-data" style="display:none;">No members found.</div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">Membership Growth</h3>
                        <select id="timeRange" class="time-selector">
                            <option value="week">Last Week</option>
                            <option value="month" selected>Last Month</option>
                            <option value="quarter">Last Quarter</option>
                        </select>
                    </div>
                    <div class="chart-container" id="membershipChart"><svg width="100%" height="100%" viewBox="0 0 400 200" id="membershipSvg"></svg></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header"><h3 class="chart-title">Club Distribution</h3></div>
                    <div class="chart-container" id="clubChart"><svg width="100%" height="100%" viewBox="0 0 300 200" id="clubSvg"></svg></div>
                </div>
            </div>

            <div class="recent-activity">
                <h3 class="chart-title">Recent Activity</h3>
                <ul class="activity-list" id="activityList"></ul>
            </div>

            <div class="quick-actions">
                <a href="createBookClub.html" class="action-btn"><div class="action-icon"><i class="fas fa-plus-circle"></i></div><div class="action-label">Create Book Club</div></a>
                <a href="createEvent.html" class="action-btn"><div class="action-icon"><i class="fas fa-calendar-plus"></i></div><div class="action-label">Schedule Event</div></a>
                <a href="#" class="action-btn"><div class="action-icon"><i class="fas fa-download"></i></div><div class="action-label">Export Data</div></a>
                <a href="#" class="action-btn" onclick="refreshData()"><div class="action-icon"><i class="fas fa-sync-alt"></i></div><div class="action-label">Refresh Analytics</div></a>
            </div>
        </main>
    </div>

    <!-- Toast -->
    <div id="toast"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA7mRqliOrAZbvcS6jpyrOUvG1Oxd-fOVA",
            authDomain: "empowermentlibrary-4e69a.firebaseapp.com",
            projectId: "empowermentlibrary-4e69a",
            storageBucket: "empowermentlibrary-4e69a.appspot.com",
            messagingSenderId: "86100116391",
            appId: "1:86100116391:web:68a0766a05d1ea61242c82"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Highlight active sidebar link
        function setActiveLink() {
            const current = location.pathname.split('/').pop() || 'admin.html';
            document.querySelectorAll('.sidebar a').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === current) {
                    link.classList.add('active');
                }
            });
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                const [clubsSnap, eventsSnap, usersSnap, contactsSnap] = await Promise.all([
                    getDocs(collection(db, "club")),
                    getDocs(collection(db, "events")),
                    getDocs(collection(db, "users")),
                    getDocs(collection(db, "contacts"))
                ]);

                document.getElementById('totalClubs').textContent = clubsSnap.size;
                document.getElementById('totalEvents').textContent = eventsSnap.size;
                document.getElementById('totalMembers').textContent = usersSnap.size;
                document.getElementById('totalContacts').textContent = contactsSnap.size;

                generateMembershipChart();
                generateClubDistributionChart();
                loadMembers();
            } catch (e) { console.error("Dashboard load error:", e); }
        }

        // Members List
        async function loadMembers() {
            const tbody = document.getElementById('membersTableBody');
            const loading = document.getElementById('membersLoading');
            const empty = document.getElementById('membersEmpty');
            const table = document.getElementById('membersTable');

            loading.style.display = 'block';
            empty.style.display = 'none';
            table.style.display = 'none';
            tbody.innerHTML = '';

            try {
                const snap = await getDocs(collection(db, "users"));
                if (snap.empty) { empty.style.display = 'block'; return; }

                snap.forEach(d => {
                    const data = d.data();
                    const row = document.createElement('tr');

                    const nameTd = document.createElement('td');
                    nameTd.textContent = data.fullName || '—';
                    row.appendChild(nameTd);

                    const emailTd = document.createElement('td');
                    emailTd.textContent = data.email || '—';
                    row.appendChild(emailTd);

                    const statusTd = document.createElement('td');
                    const badge = document.createElement('span');
                    badge.className = 'status-badge';
                    const suspended = !!data.suspended;
                    badge.classList.add(suspended ? 'status-suspended' : 'status-active');
                    badge.textContent = suspended ? 'Suspended' : 'Active';
                    statusTd.appendChild(badge);
                    row.appendChild(statusTd);

                    const actionsTd = document.createElement('td');

                    const suspendBtn = document.createElement('button');
                    suspendBtn.className = 'action-btn-small';
                    suspendBtn.classList.add(suspended ? 'btn-unsuspend' : 'btn-suspend');
                    suspendBtn.textContent = suspended ? 'Unsuspend' : 'Suspend';
                    suspendBtn.onclick = () => suspendUser(d.id, suspended);
                    actionsTd.appendChild(suspendBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'action-btn-small btn-delete';
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.onclick = () => deleteUser(d.id);
                    actionsTd.appendChild(deleteBtn);

                    row.appendChild(actionsTd);
                    tbody.appendChild(row);
                });

                table.style.display = 'table';
            } catch (err) {
                console.error(err);
                const r = document.createElement('tr');
                const c = document.createElement('td'); c.colSpan = 4; c.textContent = 'Failed to load members.'; c.style.color = '#e74c3c';
                r.appendChild(c); tbody.appendChild(r);
            } finally {
                loading.style.display = 'none';
            }
        }

        // Suspend / Unsuspend
        async function suspendUser(uid, currentlySuspended) {
            if (!confirm(`Are you sure you want to ${currentlySuspended ? 'UNSUSPEND' : 'SUSPEND'} this user?`)) return;
            const userRef = doc(db, "users", uid);
            try {
                await updateDoc(userRef, { suspended: !currentlySuspended });
                showToast(`User ${currentlySuspended ? 'unsuspended' : 'suspended'} successfully.`, 'success');
                loadMembers();
            } catch (e) {
                console.error(e);
                showToast('Failed to update user.', 'error');
            }
        }

        // Delete User
        async function deleteUser(uid) {
            if (!confirm('PERMANENTLY DELETE this user? This cannot be undone.')) return;
            const userRef = doc(db, "users", uid);
            try {
                await deleteDoc(userRef);
                showToast('User deleted permanently.', 'success');
                loadMembers();
                const cur = parseInt(document.getElementById('totalMembers').textContent);
                document.getElementById('totalMembers').textContent = Math.max(0, cur - 1);
            } catch (e) {
                console.error(e);
                showToast('Failed to delete user.', 'error');
            }
        }

        // Toast
        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast-${type}`;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Charts (static for now)
        function generateMembershipChart() {
            const svg = document.getElementById('membershipSvg'); svg.innerHTML = '';
            const data = [50,75,100,120,140,156]; const max = Math.max(...data);
            const w = 50, s = 20, h = 180;
            data.forEach((v,i) => {
                const bh = (v/max)*h, x = i*(w+s)+30, y = h-bh+10;
                const bar = document.createElementNS("http://www.w3.org/2000/svg","rect");
                bar.setAttribute("x",x); bar.setAttribute("y",y); bar.setAttribute("width",w); bar.setAttribute("height",bh);
                bar.setAttribute("fill","#3498db"); svg.appendChild(bar);

                const txt = document.createElementNS("http://www.w3.org/2000/svg","text");
                txt.setAttribute("x",x+w/2); txt.setAttribute("y",y-5); txt.setAttribute("text-anchor","middle");
                txt.setAttribute("fill","#2c3e50"); txt.setAttribute("font-size","12"); txt.textContent = v;
                svg.appendChild(txt);
            });
        }

        function generateClubDistributionChart() {
            const svg = document.getElementById('clubSvg'); svg.innerHTML = '';
            const data = [{name:"Fiction",value:4},{name:"Non-Fiction",value:3},{name:"Business",value:2},{name:"Science",value:2},{name:"Other",value:1}];
            const total = data.reduce((a,b)=>a+b.value,0);
            let start = 0; const r = 80, cx = 150, cy = 100;
            const colors = ['#3498db','#e74c3c','#2ecc71','#f39c12','#9b59b6'];
            data.forEach((d,i) => {
                const pct = d.value/total, end = start + pct*2*Math.PI;
                const x1 = cx + r*Math.cos(start), y1 = cy + r*Math.sin(start);
                const x2 = cx + r*Math.cos(end),   y2 = cy + r*Math.sin(end);
                const large = pct>0.5?1:0;
                const path = document.createElementNS("http://www.w3.org/2000/svg","path");
                path.setAttribute("d",`M ${cx},${cy} L ${x1},${y1} A ${r},${r} 0 ${large},1 ${x2},${y2} Z`);
                path.setAttribute("fill",colors[i]); path.setAttribute("stroke","#fff"); path.setAttribute("stroke-width","2");
                svg.appendChild(path);

                const ly = 30 + i*25;
                const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
                rect.setAttribute("x",250); rect.setAttribute("y",ly-10); rect.setAttribute("width",15); rect.setAttribute("height",15);
                rect.setAttribute("fill",colors[i]); svg.appendChild(rect);

                const txt = document.createElementNS("http://www.w3.org/2000/svg","text");
                txt.setAttribute("x",270); txt.setAttribute("y",ly); txt.setAttribute("fill","#2c3e50");
                txt.setAttribute("font-size","12"); txt.textContent = `${d.name} (${d.value})`;
                svg.appendChild(txt);

                start = end;
            });
        }

        // Refresh
        function refreshData() {
            const btn = event.target.closest('.action-btn');
            const orig = btn.innerHTML;
            btn.innerHTML = '<div class="loading"></div><div>Refreshing...</div>';
            setTimeout(() => { loadDashboardData(); btn.innerHTML = orig; }, 1500);
        }

        // Mobile Menu
        document.querySelector('.hamburger')?.addEventListener('click', () => {
            document.querySelector('.nav-menu').classList.toggle('active');
        });

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            setActiveLink();
            loadDashboardData();
            setInterval(loadDashboardData, 300000);
        });
    </script>
</body>
</html>